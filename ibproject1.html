<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Teachable Machine Audio Control</title>
</head>
<body>
    <h2>ğŸ¤ Voice Control with Teachable Machine & Arduino</h2>

    <button id="connect">ğŸ”Œ Connect Arduino</button>
    <button onclick="init()">ğŸ™ï¸ Start Listening</button>

    <div id="label-container" style="margin-top:20px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

    <script>
    // ====== ëª¨ë¸ ê²½ë¡œ ì„¤ì • (GitHub Pages ì ˆëŒ€ ì£¼ì†Œë¡œ ìˆ˜ì •) ======
    // âš ï¸ ì´ ì£¼ì†ŒëŠ” ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ GitHub Pages ì£¼ì†Œì…ë‹ˆë‹¤.
    const URL = "https://ldh62965961-lgtm.github.io/tm-arduino/my_model/"; 
    
    // ====== ëª…ë ¹ì–´ ë§¤í•‘: ëª¨ë¸ í´ë˜ìŠ¤ ì´ë¦„ â†’ ì•„ë‘ì´ë…¸ë¡œ ë³´ë‚¼ ë¬¸ìì—´ ======
    // ğŸš¨ ë°˜ë“œì‹œ Teachable Machineì—ì„œ í´ë˜ìŠ¤ ì´ë¦„ì„ ON_CMD, OFF_CMDë¡œ ìƒˆë¡œ í•™ìŠµì‹œì¼œì•¼ í•©ë‹ˆë‹¤.
    const CMD_MAP = {
        "ON_CMD": "LED_ON",        // ON_CMDê°€ ì¸ì‹ë˜ë©´ 180ë„ íšŒì „ ëª…ë ¹ ì „ì†¡
        "OFF_CMD": "LED_OFF",      // OFF_CMDê°€ ì¸ì‹ë˜ë©´ 0ë„ ë³µê·€ ëª…ë ¹ ì „ì†¡
        "background noise": "NONE"
    };

    let port, writer;

    // ====== ì•„ë‘ì´ë…¸ ì—°ê²° (Web Serial API) ======
    document.getElementById("connect").onclick = async () => {
        if (writer) {
            writer.releaseLock();
            writer = null;
            alert("âœ… ì—°ê²° í•´ì œ ì™„ë£Œ!");
            return;
        }

        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 }); 
            writer = port.writable.getWriter();
            console.log("âœ… Arduino connected");
            alert("âœ… ì•„ë‘ì´ë…¸ ì—°ê²° ì™„ë£Œ! Start Listeningì„ ëˆ„ë¥´ì„¸ìš”.");
        } catch (err) {
            console.error("âŒ ì—°ê²° ì‹¤íŒ¨:", err);
            alert("âŒ ì—°ê²° ì‹¤íŒ¨: COM í¬íŠ¸ê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì´ê±°ë‚˜ ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }
    };

    // ====== ëª…ë ¹ ì „ì†¡ í•¨ìˆ˜ ======
    async function sendCmd(cmd){
        if(!writer) return;
        await writer.write(new TextEncoder().encode(cmd + "\n"));
        console.log("â¡ Sent to Arduino:", cmd);
    }

    // ====== ëª¨ë¸ ë¡œë“œ ======
    async function createModel() {
        const recognizer = speechCommands.create(
            "BROWSER_FFT",
            undefined,
            URL + "model.json",
            URL + "metadata.json"
        );
        await recognizer.ensureModelLoaded();
        return recognizer;
    }

    // ====== ë©”ì¸ ë¡œì§ (ìŒì„± ì¸ì‹ ì‹œì‘) ======
    async function init() {
        try {
            const recognizer = await createModel();
            const classLabels = recognizer.wordLabels();
            const labelContainer = document.getElementById("label-container");
            labelContainer.innerHTML = classLabels.map(l => `<div>${l}</div>`).join("");

            recognizer.listen(result => {
                const scores = result.scores;
                let maxIdx = scores.indexOf(Math.max(...scores));
                const bestName = classLabels[maxIdx];
                const prob = scores[maxIdx].toFixed(2);
                
                // âš ï¸ ë””ë²„ê¹… ì½”ë“œ: ëª¨ë“  ì˜ˆì¸¡ ê°’ì„ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ ì…ë ¥ í™•ì¸
                console.log("ì¸ì‹ ì‹œë„:", bestName, "í™•ë¥ :", prob); 

                for (let i = 0; i < classLabels.length; i++) {
                    labelContainer.children[i].innerHTML =
                        `${classLabels[i]}: ${scores[i].toFixed(2)}`;
                }

                // 20% ì´ìƒì˜ í™•ë¥ ë¡œ ì¸ì‹ë˜ì—ˆì„ ë•Œ ëª…ë ¹ ì‹¤í–‰
                if (prob > 0.20 && CMD_MAP[bestName] && CMD_MAP[bestName] !== "NONE") {
                    sendCmd(CMD_MAP[bestName]);
                }
            }, {
                overlapFactor: 0.5,
                probabilityThreshold: 0
            });
            alert("ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘! ë§ˆì´í¬ì— ëŒ€ê³  ëª…ë ¹ì–´ë¥¼ ë§í•˜ì„¸ìš”.");
        } catch (e) {
            console.error("âŒ ëª¨ë¸ ë¡œë“œ ë˜ëŠ” ë§ˆì´í¬ ì˜¤ë¥˜:", e);
            alert("âŒ ì˜¤ë¥˜ ë°œìƒ: ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }
    </script>
</body>
</html>
