<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>ë‹¤ê¸°ëŠ¥ ìŒì„± ì œì–´ (ìµœì¢…)</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #EEE; }
        button { font-size: 1.2rem; padding: 10px; margin: 5px; }
        #label-container { margin-top: 20px; font-size: 1.5rem; }
        .label { color: #888; }
        .label.active { color: #FFF; font-weight: bold; }
        #log { margin-top:20px; font-family: monospace; }
    </style>
</head>
<body>
    <h2>ğŸ¤ ë‹¤ê¸°ëŠ¥ ìŒì„± ì œì–´ (ìµœì¢…)</h2>
    <button id="connect">ğŸ”Œ 1. ì•„ë‘ì´ë…¸ ì—°ê²°</button>
    <button onclick="init()">ğŸ§ 2. ìŒì„± ì¸ì‹ ì‹œì‘</button>
    <div id="label-container"></div>
    <div id="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

    <script>
    // âš ï¸ GitHub Pages ì£¼ì†ŒëŠ” ì •í™•íˆ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.
    const URL ="https://ldh62965961-lgtm.github.io/tm-arduino/my_model1/" ;

    // ==========================================================
    // â­ï¸ 1. CMD_MAP (ìƒˆ ì•„ë‘ì´ë…¸ ëª…ë ¹ì–´ì— ë§ê²Œ ë§¤í•‘)
    // ğŸš¨ Teachable Machine ë ˆì´ë¸”ì„ ì•„ë‘ì´ë…¸ ëª…ë ¹ì–´ë¡œ ì •í™•íˆ ë§¤í•‘í•©ë‹ˆë‹¤.
    // ==========================================================
    const CMD_MAP = {
        // âš ï¸ ëª¨ë¸ì´ ì¶œë ¥í•˜ëŠ” ë ˆì´ë¸”ì„ ì—¬ê¸°ì— ë§¤í•‘í•©ë‹ˆë‹¤.
        "ì»¤íŠ¼ ì˜¬ë ¤ì¤˜": "onservo",         // â¬…ï¸ Class 2 ì¸ì‹ ì‹œ ëª¨í„° ì‘ë™ ëª…ë ¹ ì „ì†¡
        "ì»¤íŠ¼ ë‚´ë ¤ì¤˜": "offservo",        // â¬…ï¸ Class 1 ì¸ì‹ ì‹œ ëª¨í„° ë©ˆì¶¤ ëª…ë ¹ ì „ì†¡ (ê°€ì •)
        "ë¶ˆ ì¼œì¤˜": "onlight",         // ë§Œì•½ ëª¨ë¸ì´ 'ë¶ˆ ì¼œì¤˜'ë¡œ í•™ìŠµë˜ì—ˆë‹¤ë©´
        "ë¶ˆ êº¼ì¤˜": "offlight",        // ë§Œì•½ ëª¨ë¸ì´ 'ë¶ˆ êº¼ì¤˜'ë¡œ í•™ìŠµë˜ì—ˆë‹¤ë©´
        "ì˜¨ìŠµë„ ì¸¡ì •í•´ì¤˜": "temp",    // ë§Œì•½ ëª¨ë¸ì´ 'ì˜¨ìŠµë„ ì¸¡ì •í•´ì¤˜'ë¡œ í•™ìŠµë˜ì—ˆë‹¤ë©´
        
        // --- (ë””ë²„ê¹…ìš© ëª…ë ¹ ë° ë°°ê²½ ì†ŒìŒ) ---
        "ë°°ê²½ ì†ŒìŒ": "NONE",
        "_background_noise_": "NONE"
    };
    // ==========================================================

    let port, writer;
    const logEl = document.getElementById("log");
    
    // í™”ë©´ì— ë¡œê·¸ë¥¼ ì°ëŠ” í•¨ìˆ˜
    function log(msg) {
      logEl.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + logEl.innerHTML;
    }

    // ì•„ë‘ì´ë…¸ ì—°ê²°
    document.getElementById("connect").onclick = async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        alert("âœ… ì•„ë‘ì´ë…¸ ì—°ê²° ì„±ê³µ!");
        log("âœ… ì•„ë‘ì´ë…¸ ì—°ê²° ì„±ê³µ (Baud: 115200)");
      } catch (e) {
        log("âŒ ì•„ë‘ì´ë…¸ ì—°ê²° ì‹¤íŒ¨: " + e.message);
      }
    };

    // ëª…ë ¹ ì „ì†¡ í•¨ìˆ˜
    async function sendCmd(cmd) {
      if (!writer) {
        log("âŒ ì•„ë‘ì´ë…¸ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }
      log(`â¡ Sent: ${cmd}`);
      // ì•„ë‘ì´ë…¸ê°€ LIGHT_ON\n ë˜ëŠ” LIGHT_OFF\n ë¬¸ìì—´ì„ ë°›ë„ë¡ ì „ì†¡
      await writer.write(new TextEncoder().encode(cmd + "\n"));
    }

    // ëª¨ë¸ ë¡œë“œ
    async function createModel() {
      const recognizer = speechCommands.create(
        "BROWSER_FFT", undefined,
        URL + "model.json", URL + "metadata.json"
      );
      await recognizer.ensureModelLoaded();
      return recognizer;
    }

    // ìŒì„± ì¸ì‹ ì‹œì‘
    async function init() {
      try {
        const recognizer = await createModel();
        const classLabels = recognizer.wordLabels();
        const container = document.getElementById("label-container");
        container.innerHTML = "";
        classLabels.forEach(l => {
          container.innerHTML += `<div id="label-${l}" class="label">${l}: 0%</div>`;
        });

        log("ğŸ§ ìŒì„± ì¸ì‹ ì‹œì‘...");

        recognizer.listen(result => {
          const scores = result.scores;
          let maxIdx = scores.indexOf(Math.max(...scores));
          const best = classLabels[maxIdx];
          const prob = scores[maxIdx];

          // â­ï¸ F12 ì½˜ì†” ë¡œê·¸ (ë””ë²„ê¹…ìš©)
          console.log(`[ëª¨ë¸ ì›ë³¸ ì¶œë ¥] ë ˆì´ë¸”: "${best}", í™•ë¥ : ${prob.toFixed(2)}`);

          // í™”ë©´ì— í™•ë¥  í‘œì‹œ ë° í™œì„±í™”
          for (let i = 0; i < classLabels.length; i++) {
            const el = document.getElementById(`label-${classLabels[i]}`);
            el.innerHTML = `${classLabels[i]}: ${ (scores[i] * 100).toFixed(0) }%`;
            el.className = (i === maxIdx) ? "label active" : "label";
          }
          
          const command = CMD_MAP[best];  
          
          // í™•ë¥  80% ì´ìƒì´ê³ , ìœ íš¨í•œ ëª…ë ¹ì–´ì¼ ë•Œë§Œ ì „ì†¡
          if (prob > 0.5 && command && command !== "NONE") { 
            log(`[ëª…ë ¹ ê°ì§€] "${best}" -> ${command} (í™•ë¥  ${prob.toFixed(2)})`);
            sendCmd(command);
          }
        }, {
          overlapFactor: 0.5,
          probabilityThreshold: 0.5 
        });
      } catch (e) {
        log(`âŒ ERROR: ${e.message}`);
      }
    }
    </script>
</body>
</html>

