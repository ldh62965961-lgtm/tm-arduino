<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ë‹¤ê¸°ëŠ¥ ìŒì„± ì œì–´ (ë””ë²„ê¹… ëª¨ë“œ)</title>
  <style>
    /* (ì´ì „ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼) */
    body { font-family: sans-serif; background: #222; color: #EEE; }
    button { font-size: 1.2rem; padding: 10px; margin: 5px; }
    #label-container { margin-top: 20px; font-size: 1.5rem; }
    .label { color: #888; }
    .label.active { color: #FFF; font-weight: bold; }
    #log { margin-top:20px; font-family: monospace; }
  </style>
</head>
<body>
  <h2>ğŸ™ï¸ ë‹¤ê¸°ëŠ¥ ìŒì„± ì œì–´ (ë””ë²„ê¹… ëª¨ë“œ)</h2>
  <button id="connect">ğŸ”Œ 1. ì•„ë‘ì´ë…¸ ì—°ê²°</button>
  <button onclick="init()">ğŸ§ 2. ìŒì„± ì¸ì‹ ì‹œì‘</button>
  <div id="label-container"></div>
  <div id="log"></div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

  <script>
    const URL = window.location.origin + "/my_model1/";

    // ==========================================================
    // â­ï¸ 1. CMD_MAP
    // Teachable Machine ë ˆì´ë¸”ê³¼ 100% ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
    // ë§Œì•½ ëª¨ë¸ì´ "Class 2"ë¥¼ ì¶œë ¥í•˜ë©´, "Class 2": "LIGHT_OFF"ë¡œ ë§ì¶°ì•¼ í•©ë‹ˆë‹¤.
    // ==========================================================
    const CMD_MAP = {
      "ë¶ˆ ì¼œì¤˜": "LIGHT_ON",
      "ë¶ˆ êº¼ì¤˜": "LIGHT_OFF",
      "ì»¤íŠ¼ ì˜¬ë ¤ì¤˜": "CURTAIN_UP",
      "ì»¤íŠ¼ ë‚´ë ¤ì¤˜": "CURTAIN_DOWN",
      "ì˜¨ìŠµë„ ì¸¡ì •í•´ì¤˜": "GET_SENSOR",
      "ë°°ê²½ ì†ŒìŒ": "NONE",
      
      // --- (ë””ë²„ê¹…ìš©) ë§Œì•½ ëª¨ë¸ì´ ì•„ì§ë„ Class ì´ë¦„ì„ ì“´ë‹¤ë©´ ---
      "Class 1": "LIGHT_ON",
      "Class 2": "LIGHT_OFF",
      "_background_noise_": "NONE"
    };
    // ==========================================================

    let port, writer;
    const logEl = document.getElementById("log");
    
    // í™”ë©´ì— ë¡œê·¸ë¥¼ ì°ëŠ” í•¨ìˆ˜
    function log(msg) {
      logEl.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + logEl.innerHTML;
    }

    // (ì—°ê²° ë²„íŠ¼ ë“± ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ì´ì „ê³¼ ë™ì¼...)
    document.getElementById("connect").onclick = async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        alert("âœ… ì•„ë‘ì´ë…¸ ì—°ê²° ì„±ê³µ!");
        log("âœ… ì•„ë‘ì´ë…¸ ì—°ê²° ì„±ê³µ (Baud: 115200)");
      } catch (e) {
        log("âŒ ì•„ë‘ì´ë…¸ ì—°ê²° ì‹¤íŒ¨: " + e.message);
      }
    };

    async function sendCmd(cmd) {
      if (!writer) {
        log("âŒ ì•„ë‘ì´ë…¸ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
      }
      log(`â¡ Sent: ${cmd}`);
      await writer.write(new TextEncoder().encode(cmd + "\n"));
    }

    // 2. ìŒì„± ì¸ì‹ ì‹œì‘
    async function init() {
      const recognizer = speechCommands.create(
        "BROWSER_FFT", undefined,
        URL + "model.json", URL + "metadata.json"
      );
      await recognizer.ensureModelLoaded();
      
      const classLabels = recognizer.wordLabels();
      const container = document.getElementById("label-container");
      classLabels.forEach(l => {
        container.innerHTML += `<div id="label-${l}" class="label">${l}: 0%</div>`;
      });

      log("ğŸ§ ìŒì„± ì¸ì‹ ì‹œì‘...");

      recognizer.listen(result => {
        const scores = result.scores;
        let maxIdx = scores.indexOf(Math.max(...scores));
        const best = classLabels[maxIdx]; // â­ï¸ ëª¨ë¸ì´ ì¶œë ¥í•œ ì‹¤ì œ ë ˆì´ë¸”
        const prob = scores[maxIdx];

        // ==========================================================
        // â­ï¸ 2. ìš”ì²­í•˜ì‹  ì½˜ì†” ë¡œê·¸ (F12 ê°œë°œì ë„êµ¬)
        // ëª¨ë¸ì´ ì‹¤ì œë¡œ ì–´ë–¤ ë ˆì´ë¸”ì„ ì¶œë ¥í•˜ëŠ”ì§€ ì—¬ê¸°ì„œ í™•ì¸í•˜ì„¸ìš”.
        console.log(`[ëª¨ë¸ ì›ë³¸ ì¶œë ¥] ë ˆì´ë¸”: "${best}", í™•ë¥ : ${prob.toFixed(2)}`);
        // ==========================================================

        // í™”ë©´ì— í™•ë¥  í‘œì‹œ
        for (let i = 0; i < classLabels.length; i++) {
          const el = document.getElementById(`label-${classLabels[i]}`);
          el.innerHTML = `${classLabels[i]}: ${ (scores[i] * 100).toFixed(0) }%`;
          el.className = (i === maxIdx) ? "label active" : "label";
        }
        
        // ë§µì—ì„œ ëª…ë ¹ì–´ ì°¾ê¸°
        const command = CMD_MAP[best]; 
        
        // í™•ë¥  70% ì´ìƒì´ê³ , ìœ íš¨í•œ ëª…ë ¹ì–´ì¼ ë•Œë§Œ ì „ì†¡
        if (prob > 0.7 && command && command !== "NONE") { 
          log(`[ëª…ë ¹ ê°ì§€] "${best}" (í™•ë¥  ${prob.toFixed(2)})`);
          sendCmd(command);
        }
      }, {
        overlapFactor: 0.5,
        probabilityThreshold: 0.5 
      });
    }
  </script>
</body>
</html>